<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>工作原理 | 皮卡丘博客</title>
    <meta name="description" content="操千曲而后晓声 观千剑而后识器">
    <link rel="icon" href="/syBlog/pkq.jpeg">
    
    <link rel="preload" href="/syBlog/assets/css/0.styles.302bd28f.css" as="style"><link rel="preload" href="/syBlog/assets/js/app.a437376f.js" as="script"><link rel="preload" href="/syBlog/assets/js/47.14c7bcfe.js" as="script"><link rel="prefetch" href="/syBlog/assets/js/10.ee33b3f5.js"><link rel="prefetch" href="/syBlog/assets/js/11.3718baca.js"><link rel="prefetch" href="/syBlog/assets/js/12.de9cd000.js"><link rel="prefetch" href="/syBlog/assets/js/13.27203d70.js"><link rel="prefetch" href="/syBlog/assets/js/14.f7abf074.js"><link rel="prefetch" href="/syBlog/assets/js/15.c086b7ea.js"><link rel="prefetch" href="/syBlog/assets/js/16.f7354e27.js"><link rel="prefetch" href="/syBlog/assets/js/17.c1e34b5b.js"><link rel="prefetch" href="/syBlog/assets/js/18.ed202478.js"><link rel="prefetch" href="/syBlog/assets/js/19.10e077de.js"><link rel="prefetch" href="/syBlog/assets/js/2.041caa87.js"><link rel="prefetch" href="/syBlog/assets/js/20.12745d0f.js"><link rel="prefetch" href="/syBlog/assets/js/21.3e6506d9.js"><link rel="prefetch" href="/syBlog/assets/js/22.fb1a8ac6.js"><link rel="prefetch" href="/syBlog/assets/js/23.ad424734.js"><link rel="prefetch" href="/syBlog/assets/js/24.5b2df2ad.js"><link rel="prefetch" href="/syBlog/assets/js/25.287ad44c.js"><link rel="prefetch" href="/syBlog/assets/js/26.642ff326.js"><link rel="prefetch" href="/syBlog/assets/js/27.f0f2f31a.js"><link rel="prefetch" href="/syBlog/assets/js/28.bc5bfca3.js"><link rel="prefetch" href="/syBlog/assets/js/29.da76d747.js"><link rel="prefetch" href="/syBlog/assets/js/3.7a0da7d9.js"><link rel="prefetch" href="/syBlog/assets/js/30.18279763.js"><link rel="prefetch" href="/syBlog/assets/js/31.480f0a33.js"><link rel="prefetch" href="/syBlog/assets/js/32.1d5956dc.js"><link rel="prefetch" href="/syBlog/assets/js/33.3e708b82.js"><link rel="prefetch" href="/syBlog/assets/js/34.27476279.js"><link rel="prefetch" href="/syBlog/assets/js/35.314cb3ee.js"><link rel="prefetch" href="/syBlog/assets/js/36.bcd316c7.js"><link rel="prefetch" href="/syBlog/assets/js/37.702c44a4.js"><link rel="prefetch" href="/syBlog/assets/js/38.888f06ad.js"><link rel="prefetch" href="/syBlog/assets/js/39.1646acc4.js"><link rel="prefetch" href="/syBlog/assets/js/4.e5ff62f4.js"><link rel="prefetch" href="/syBlog/assets/js/40.54e349d4.js"><link rel="prefetch" href="/syBlog/assets/js/41.6860ba2e.js"><link rel="prefetch" href="/syBlog/assets/js/42.c70a8cf2.js"><link rel="prefetch" href="/syBlog/assets/js/43.957ec1dd.js"><link rel="prefetch" href="/syBlog/assets/js/44.b793b16b.js"><link rel="prefetch" href="/syBlog/assets/js/45.1bed48fa.js"><link rel="prefetch" href="/syBlog/assets/js/46.6e1f18b0.js"><link rel="prefetch" href="/syBlog/assets/js/48.6842edb1.js"><link rel="prefetch" href="/syBlog/assets/js/49.495d03f8.js"><link rel="prefetch" href="/syBlog/assets/js/5.dc843bc2.js"><link rel="prefetch" href="/syBlog/assets/js/50.1dc06599.js"><link rel="prefetch" href="/syBlog/assets/js/51.e416e636.js"><link rel="prefetch" href="/syBlog/assets/js/52.1d6a01a6.js"><link rel="prefetch" href="/syBlog/assets/js/53.361d44bd.js"><link rel="prefetch" href="/syBlog/assets/js/54.4f8034bf.js"><link rel="prefetch" href="/syBlog/assets/js/55.b3045951.js"><link rel="prefetch" href="/syBlog/assets/js/56.4a55572f.js"><link rel="prefetch" href="/syBlog/assets/js/57.389473ae.js"><link rel="prefetch" href="/syBlog/assets/js/58.af62ae97.js"><link rel="prefetch" href="/syBlog/assets/js/59.96ca446f.js"><link rel="prefetch" href="/syBlog/assets/js/6.8aa2c987.js"><link rel="prefetch" href="/syBlog/assets/js/60.a08edc84.js"><link rel="prefetch" href="/syBlog/assets/js/61.5370812c.js"><link rel="prefetch" href="/syBlog/assets/js/62.8d8aab53.js"><link rel="prefetch" href="/syBlog/assets/js/63.6a78976b.js"><link rel="prefetch" href="/syBlog/assets/js/64.ea809fc1.js"><link rel="prefetch" href="/syBlog/assets/js/65.3824484a.js"><link rel="prefetch" href="/syBlog/assets/js/7.cfe89f94.js"><link rel="prefetch" href="/syBlog/assets/js/8.333f5770.js"><link rel="prefetch" href="/syBlog/assets/js/9.e15b46dc.js">
    <link rel="stylesheet" href="/syBlog/assets/css/0.styles.302bd28f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/syBlog/" class="home-link router-link-active"><!----> <span class="site-name">皮卡丘博客</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">软基</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/dataAndAlg/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/designPattern/" class="nav-link">模式和原则</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/basic/" class="nav-link">网络协议</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端体系</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/Browser/" class="nav-link router-link-active">浏览器</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/API/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/Node/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/deepKnow/" class="nav-link">场景深入</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/RollupTools/" class="nav-link">前端工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">OTHER</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/Other/GoodQS/" class="nav-link">好问题</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/English/" class="nav-link">英文</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/mobileQS/" class="nav-link">移动端问题</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/fontendLink/" class="nav-link">好文连接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/Leetcode/LinkedList/" class="nav-link">链表</a></li></ul></div></div> <a href="https://github.com/facebook201/sy-fontend-system" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">软基</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/dataAndAlg/" class="nav-link">数据结构</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/algorithm/" class="nav-link">算法</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/designPattern/" class="nav-link">模式和原则</a></li><li class="dropdown-item"><!----> <a href="/syBlog/computerBasics/basic/" class="nav-link">网络协议</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">前端体系</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/CSS/" class="nav-link">CSS</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/JS/" class="nav-link">JS</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/Browser/" class="nav-link router-link-active">浏览器</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/API/" class="nav-link">API</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/Node/" class="nav-link">Node</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/deepKnow/" class="nav-link">场景深入</a></li><li class="dropdown-item"><!----> <a href="/syBlog/fontEnd/RollupTools/" class="nav-link">前端工程化</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">OTHER</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/Other/GoodQS/" class="nav-link">好问题</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/English/" class="nav-link">英文</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/mobileQS/" class="nav-link">移动端问题</a></li><li class="dropdown-item"><!----> <a href="/syBlog/Other/fontendLink/" class="nav-link">好文连接</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">LeetCode</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/syBlog/Leetcode/LinkedList/" class="nav-link">链表</a></li></ul></div></div> <a href="https://github.com/facebook201/sy-fontend-system" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav> <div class="load-success"><div id="codefund"></div></div> <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>浏览器</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/syBlog/fontEnd/Browser/" aria-current="page" class="sidebar-link">浏览器</a></li><li><a href="/syBlog/fontEnd/Browser/browser.html" aria-current="page" class="active sidebar-link">工作原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/syBlog/fontEnd/Browser/browser.html#多进程架构" class="sidebar-link">多进程架构</a></li><li class="sidebar-sub-header"><a href="/syBlog/fontEnd/Browser/browser.html#消息队列和事件循环" class="sidebar-link">消息队列和事件循环</a></li><li class="sidebar-sub-header"><a href="/syBlog/fontEnd/Browser/browser.html#v8怎么实现异步编程" class="sidebar-link">V8怎么实现异步编程</a></li></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="工作原理"><a href="#工作原理" class="header-anchor">#</a> 工作原理</h1> <h2 id="多进程架构"><a href="#多进程架构" class="header-anchor">#</a> 多进程架构</h2> <p><strong>我们平时接触的js主要有两个运行环境，一个是Node，一个是浏览器。平时说的JavaScript是单线程，其实说的是运行在Render 进程的 主线程上。而运行环境是多线程的，你看到的是单线程而已， 现代浏览器主要都是多进程架构</strong></p> <h3 id="进程分类"><a href="#进程分类" class="header-anchor">#</a> 进程分类</h3> <h3 id="插件进程（plugin-process"><a href="#插件进程（plugin-process" class="header-anchor">#</a> 插件进程（Plugin process)</h3> <p>就是插件运行的进程，每个插件一个进程，单独隔离出是为了防止插件挂了影响用户。</p> <h3 id="gpu-进程（gpu-process）"><a href="#gpu-进程（gpu-process）" class="header-anchor">#</a> GPU 进程（GPU process）</h3> <p>负责UI界面渲染</p> <h3 id="网络进程（network-process）"><a href="#网络进程（network-process）" class="header-anchor">#</a> 网络进程（Network process）</h3> <p>负责网络资源加载</p> <h3 id="浏览器主进程（browser-process）"><a href="#浏览器主进程（browser-process）" class="header-anchor">#</a> 浏览器主进程（Browser process）</h3> <p>负责除了Tab标签页外的所有进程，包括界面展示，用户交互，子进程管理，文件存取等。</p> <h3 id="渲染进程-renderer-process）"><a href="#渲染进程-renderer-process）" class="header-anchor">#</a> 渲染进程 (Renderer process）</h3> <p>主要负责将 HTML, CSS, JavaScript 转换为用户可交互的网页，排版引擎 Blink 和 JavaScript 引擎 V8 就运行在渲染进程，默认每个 tab 一个渲染进程（特殊情况下面的进程模式会讲）。</p> <p><img src="https://pic2.zhimg.com/v2-12dcfec1e4e079c89be0c5fd086c53e5_b.jpg" alt="border"></p> <h3 id="进程的四种模式"><a href="#进程的四种模式" class="header-anchor">#</a> 进程的四种模式</h3> <p>Chromium 提供了四种进程模式，不同的进程模式会对 tab 进程做不同的处理，比如采用某个模式况会给 tab 分配新进程，而采用另外一个模式则不会，下面是四种模式的介绍，Chrome 默认采用第一个模式</p> <ul><li><strong>Process-per-site-instance</strong> (default) - 同一个 <strong>site-instance</strong> 使用一个进程</li> <li><strong>Process-per-site -</strong> 同一个 <strong>site</strong> 使用一个进程</li> <li><strong>Process-per-tab -</strong> 每个 tab 使用一个进程</li> <li><strong>Single process -</strong> 所有 tab 共用一个进程</li></ul> <p><strong>Process-per-site-instance</strong> 是最重要的，因为这个是 Chrome 默认使用的模式，也就是几乎所有的用户都在用的模式。当你打开一个 tab 访问 <a href="https://link.zhihu.com/?target=https%3A//a.baidu.com" target="_blank" rel="noopener noreferrer">https://a.baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，然后再打开一个 tab 访问 <a href="https://link.zhihu.com/?target=https%3A//b.baidu.com" target="_blank" rel="noopener noreferrer">https://b.baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，这两个 tab 会使用<strong>两个进程</strong>。如果 <a href="https://link.zhihu.com/?target=https%3A//b.baidu.com" target="_blank" rel="noopener noreferrer">https://b.baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是通过 <a href="https://link.zhihu.com/?target=https%3A//a.baidu.com" target="_blank" rel="noopener noreferrer">https://a.baidu.com<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 页面的 JavaScript 代码打开的，这两个 tab 会使用<strong>同一个进程</strong>，比如下图的例子，可以看到两个 tab 的 processId 是相同的。</p> <p>同一个进程的多个线程是共享内存的。所以当两个 tab 使用同一个进程的时候，这两个 tab 就是“通的”。比如 A 页面使用 JavaScript 打开 B 页面，那么 B 页面可以通过 <code>window.opener</code> 访问 A 页面的 <code>window</code> 对象。</p> <h3 id="面向服务的架构"><a href="#面向服务的架构" class="header-anchor">#</a> 面向服务的架构</h3> <p><img src="https://pic1.zhimg.com/v2-0ad8ab7b2df126d9ba4c08e627bdcbda_b.webp" alt="border"></p> <p>所以开了一个Tab，最少有四个进程。</p> <ul><li>浏览器进程</li> <li>GPU进程</li> <li>插件进程</li> <li>渲染进程
<ul><li>主线程：运行JavaScript、DOM、CSS、样式布局计算</li> <li>工作线程 运行 Web Worker、Service Worker</li> <li>合成线程 将图层分层 并发送绘制命令给浏览器进程</li></ul></li></ul> <h3 id="渲染的过程"><a href="#渲染的过程" class="header-anchor">#</a> 渲染的过程</h3> <p><img src alt="border"></p> <h3 id="requestanimationframe"><a href="#requestanimationframe" class="header-anchor">#</a> requestAnimationFrame</h3> <p>这是一个特殊的异步任务，注册的方法不会加入到Task队列。而是加载到渲染的队列中，在渲染的三个步骤之前执行，处理渲染相关的工作。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token string">'translateX(1000px)'</span>
box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>tranition <span class="token operator">=</span> <span class="token string">'transform 1s ease'</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> b1 <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ball1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> b2 <span class="token operator">=</span> document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'.ball2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span>

  <span class="token keyword">function</span> <span class="token function">moveBoxTenPixel</span><span class="token punctuation">(</span><span class="token parameter">box</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateX(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">*</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">moveBoxTenPixel2</span><span class="token punctuation">(</span><span class="token parameter">box</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    box<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translateX(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>j <span class="token operator">*</span> <span class="token number">1</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px)</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
    j<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">function</span> <span class="token function">moveBall</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">moveBoxTenPixel</span><span class="token punctuation">(</span>b1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span>moveBall<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// moveBall();</span>

  <span class="token keyword">function</span> <span class="token function">moveBall2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">moveBoxTenPixel2</span><span class="token punctuation">(</span>b2<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>moveBall2<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// moveBall2();</span>
</code></pre></div><p>上面的代码执行之后就会发现setTImeout要比animation快的多。</p> <p>那如果我们使用setTimeout 处理动画和此API有什么不同呢。<strong>setTimeout 每次运行结束时都把自己添加到task 队列。（不是每次执行队列都会进入到渲染循环中），所以渲染部分下一部分会更新很多像素 而不是1px。requestAnimationFrame 只在渲染过程之前运行，严格遵守执行一次渲染一次。</strong></p> <h3 id="microtasks"><a href="#microtasks" class="header-anchor">#</a> Microtasks</h3> <p>微任务队列，Microtasks 就是在 <strong>当次</strong> 事件循环的 <strong>结尾 立刻执行</strong> 的任务。<code>Promise.then()</code> 内部的代码就属于 microtasks。相对而言，之前的异步队列 (Task queue) 就叫做 macrotasks，不过一般还是简称为 tasks。加上requestAnimationFrame队列目前共有三个</p> <ul><li>Tasks (in <code>setTimeout</code>)</li> <li>Animation callbacks (in <code>requestAnimationFrame</code>)</li> <li>Microtasks (in <code>Promise.then</code>)</li></ul> <h3 id="事件循环-event-loop"><a href="#事件循环-event-loop" class="header-anchor">#</a> 事件循环 Event Loop</h3> <p><a href="http://link.zhihu.com/?target=https%3A//html.spec.whatwg.org/multipage/webappapis.html%23event-loops" target="_blank" rel="noopener noreferrer">WHATWG<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 规范中定义了事件循环，</p> <p>1、从task队列中取最老的一个task，执行它（如果没有任务队列，直接跳到微任务步骤）；</p> <p>2、<strong>Microtasks</strong>：执行microtasks任务**<a href="http://link.zhihu.com/?target=https%3A//html.spec.whatwg.org/multipage/webappapis.html%23perform-a-microtask-checkpoint" target="_blank" rel="noopener noreferrer">检查点<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>**；</p> <p>3、<strong>Update the rendering</strong>更新渲染</p> <p>4、判断是否启动**<a href="http://link.zhihu.com/?target=https%3A//w3c.github.io/requestidlecallback/%23start-an-idle-period-algorithm" target="_blank" rel="noopener noreferrer">空闲时间算法<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>**</p> <p>5、event loop 重复执行</p> <p><img src="https://pic3.zhimg.com/80/v2-625308b43e94d35a9a1367cc5ebafe2e_1440w.jpg" alt="border"></p> <p>常见的Task任务有：<code>事件回调</code>、<code>XHR回调</code>、<code>定时器</code>。其中setTimeout是多少毫秒<strong>推入task队列</strong>。</p> <h3 id="页面死的几种情况"><a href="#页面死的几种情况" class="header-anchor">#</a> 页面死的几种情况</h3> <ul><li><p>Maximum call stack size exceeded 调用栈溢出。典型的 JS stack 溢出了。一般出现递归 没有返回</p></li> <li><p>页面卡死 主线程任务队列 比如微任务一直执行，导致task 任务队列没有机会执行 卡死 其他IO设备没有反应 页面无法渲染</p> <p><a href="https://zhuanlan.zhihu.com/p/39292837" target="_blank" rel="noopener noreferrer">卡顿监控<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li> <li><p>页面直接崩溃 可能是插件问题，被攻击 防火墙等问题</p> <p><a href="https://link.zhihu.com/?target=http%3A//jasonjl.me/blog/2015/06/21/taking-action-on-browser-crashes/" target="_blank" rel="noopener noreferrer">崩溃监控<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></li></ul> <p>页面卡顿是暂时响应比较慢，JS 可能无法<strong>及时执行</strong>，崩溃就是完全看不了 页面不显示。</p> <div class="tip custom-block"><p class="custom-block-title">TIP</p> <p>1、<strong>setTimeout 不卡死是因为它被推到任务队列，会循环调用，不会阻塞页面渲染，页面会固定时间段去渲染，（前提是js不会阻塞它）。</strong></p> <p>2、<strong>微任务如果一直循环执行，会导致任务队列无法执行或相应其他的任务，比如I/O、渲染等。所以会卡死</strong></p></div> <h3 id="意外代码"><a href="#意外代码" class="header-anchor">#</a> 意外代码</h3> <div class="language-js extra-class"><pre class="language-js"><code>button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'microtask 1'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener 1'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

button<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'click'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'microtask 2'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'listener 2'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>用户直接点击的时候，浏览器先后触发 2 个 listener。第一个 listener 触发完成 (<code>listener 1</code>) 之后，队列空了，就先打印了 microtask 1。然后再执行下一个 listener。<strong>重点在于浏览器并不实现知道有几个 listener，因此它发现一个执行一个，执行完了再看后面还有没有。</strong></p> <p>而使用 <code>button.click()</code> 时，浏览器的内部实现是把 2 个 listener 都同步执行。因此 <code>listener 1</code> 之后，执行队列还没空，还要继续执行 &quot;listener 2&quot; 之后才行。所以 listener 2 会早于 microtask 1。<strong>重点在于浏览器的内部实现，<code>click</code> 方法会先采集有哪些 listener，再依次触发。</strong></p> <h2 id="消息队列和事件循环"><a href="#消息队列和事件循环" class="header-anchor">#</a> 消息队列和事件循环</h2> <h2 id="v8怎么实现异步编程"><a href="#v8怎么实现异步编程" class="header-anchor">#</a> V8怎么实现异步编程</h2></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/facebook201/sy-fontend-system/edit/master/docs/fontEnd/Browser/browser.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/syBlog/fontEnd/Browser/" class="prev router-link-active">
          浏览器
        </a></span> <!----></p></div> </div></div></div>
    <script src="/syBlog/assets/js/app.a437376f.js" defer></script><script src="/syBlog/assets/js/47.14c7bcfe.js" defer></script>
  </body>
</html>
